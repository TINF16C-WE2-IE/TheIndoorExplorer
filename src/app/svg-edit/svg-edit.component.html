<app-toolbar></app-toolbar>

<mat-sidenav-container class="example-container">
    <mat-sidenav #sidenav mode="{{sideNavMode}}" [disableClose]="editMode" class="left-sidenav">
        <mat-form-field id='search-field'>
            <input matInput type="search" incremental name="search" [(ngModel)]="searchQuery"
                   (keyup)="search(searchQuery)"
                   placeholder="Search...">
        </mat-form-field>
        <br>
        <div *ngIf="!editMode">
            <mat-form-field>
                <input matInput type="search" incremental name="search" [(ngModel)]="startQuery"
                       (keyup)="search(startQuery)"
                       placeholder="Startpoint..." (focus)="startpoint = true">
            </mat-form-field>
            <br>
            <mat-icon>more_vert</mat-icon>
            <br>
            <mat-form-field>
                <input matInput type="search" incremental name="search" [(ngModel)]="endQuery" (keyup)="search()"
                       placeholder="Endpoint..." (focus)="startpoint = false">
            </mat-form-field>
        </div>


        <div id="tools" *ngIf="editMode">
            <h2 class="mat-h2">Toolbox</h2>
            <p class="tool-buttons">
                <button mat-button *ngFor="let tool of tools"
                        [ngClass]="tool.name == selectedTool ? 'mat-raised-button tool-button' : 'tool-button'"
                        (click)="selectTool(tool.name)">
                    <mat-icon [svgIcon]="tool.icon"></mat-icon>
                    {{tool.name}}
                </button>
            </p>
            <p style="display: none">
                <input #fileUploadButton type="file" name="bgimg" id="img-upload" (change)="backgroundImage($event)"
                       accept="image/*">
            </p>
            <p>
                <button mat-button
                        (click)="fileUploadButton.click();">
                    <mat-icon>add_a_photo</mat-icon>
                    <span>Add image</span>
                </button>
                <br>
                <button mat-button>
                    <mat-icon>public</mat-icon>
                    <span>Publish map</span>
                </button>
            </p>
        </div>

        <div *ngIf="!editMode">
            <mat-nav-list>
                <span *ngFor="let f of floors; let i = index">
                    <h3 *ngIf="f.searchResults.length" mat-subheader>{{f.label.length ? f.label : i+1}}</h3>
                    <mat-list-item *ngFor="let result of f.searchResults"
                                   (click)="selectWaypoint(result)">{{result.label}}</mat-list-item>
                </span>
            </mat-nav-list>
            <p *ngIf="singleSelectedObject">
                Starting point: {{singleSelectedObject.label}}<br> <b>Select a destination</b>
            </p>
            <p *ngIf="!singleSelectedObject"><b>Select two portals to get directions</b></p>
        </div>
        <div id="properties" *ngIf="editMode">
            <h2 class="mat-h2">{{(singleSelectedObject | type) || 'Floor'}} Properties</h2>
            <mat-form-field *ngIf="floor && !singleSelectedObject">
                <input matInput name="floorname" [(ngModel)]="floor.label" placeholder="Floor Name">
            </mat-form-field>
            <mat-form-field *ngIf="singleSelectedObject">
                <input matInput name="objname" [(ngModel)]="singleSelectedObject.label" placeholder="Object Name">
            </mat-form-field>
            <mat-form-field *ngIf="(singleSelectedObject | type:'Stairs') || (singleSelectedObject | type:'Elevator')">
                <mat-select [placeholder]="'Connect ' + (singleSelectedObject | type)"
                            [value]="singleSelectedObject.group"
                            (change)="setTeleporterGroup(singleSelectedObject, $event.value)">
                    <mat-option [value]="null">None</mat-option>
                    <mat-option [value]="undefined">New group</mat-option>
                    <mat-option *ngFor="let teleporterGroup of connectibleTeleporterGroups"
                                [value]="teleporterGroup.group">
                        {{getTeleporterGroupDisplayName(teleporterGroup)}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>
    </mat-sidenav>


    <div id="viewer-container">
        <div>
            <button *ngIf="!editMode" type="button" mat-raised-button color="accent" id="search-button"
                    (click)="sidenav.open()">
                <mat-icon>location_searching</mat-icon>
                <span>Search</span>
            </button>
            <div id="canvas-container">

                <svg id="editorCanvas" #editorCanvas
                     [attr.viewBox]="viewBoxString()"
                     [style.cursor]="mouse.tool.cursorShape"
                     (mouseup)="mouse.onMouseUp($event)" (mousedown)="mouse.onMouseDown($event)"
                     (mousemove)="mouse.onMouseMove($event)" (mouseleave)="mouse.onMouseLeave($event)"
                     (touchend)="mouse.onMouseUp($event)" (touchstart)="mouse.onMouseDown($event)"
                     (touchmove)="mouse.onMouseMove($event)"
                     (pinchmove)="mouse.onPinch($event)" (pinchend)="mouse.onPinchEnd($event)"
                     (wheel)="mouse.onWheel($event)"
                     xmlns:svg="http://www.w3.org/2000/svg" version="1.2">

                    <svg:image *ngIf="backgroundImageDataURL" [attr.xlink:href]="backgroundImageDataURL" x="0" y="0"
                               width="2000"
                               height="2000" opacity="0.5" preserveAspectRatio="xMinYMin meet"/>

                    <svg:g *ngIf="floor">
                        <svg:defs>
                            <svg:marker id="circle" markerWidth="10" markerHeight="10" refX="5" refY="5"
                                        markerUnits="userSpaceOnUse">
                                <svg:circle *ngIf="editMode" cx="5" cy="5" r="4" style="stroke: none; fill:#000000;"/>
                            </svg:marker>

                            <svg:marker id="solidArrow" markerWidth="13" markerHeight="13" refX="2" refY="6"
                                        orient="auto" markerUnits="userSpaceOnUse">
                                <svg:path d="M2,2 L2,11 L10,6 L2,2" style="fill: grey;"/>
                            </svg:marker>
                        </svg:defs>

                        <svg:line *ngFor="let wall of floor.walls" stroke="black"
                                  stroke-width="3" stroke-linecap="round"
                                  [attr.x1]="wall.p1.x" [attr.y1]="wall.p1.y" [attr.x2]="wall.p2.x"
                                  [attr.y2]="wall.p2.y"
                                  marker-end="url(#circle)" marker-start="url(#circle)"/>

                        <svg:g *ngFor="let portal of floor.portals">
                            <svg:line
                                    [attr.stroke]="getSelectableColor(portal)"
                                    stroke-width="10"
                                    stroke-dasharray="2, 5"
                                    [attr.x1]="portal.p1.x" [attr.y1]="portal.p1.y" [attr.x2]="portal.p2.x"
                                    [attr.y2]="portal.p2.y"
                                    marker-end="url(#circle)" marker-start="url(#circle)"/>
                            <svg:text *ngIf="showLabels" text-anchor="middle"
                                      [attr.x]="portal.center.x" [attr.y]="portal.center.y + 20">
                                {{portal.label}}
                            </svg:text>
                        </svg:g>

                        <svg:g *ngFor="let stairs of floor.stairways">
                            <svg:line
                                    [attr.stroke]="getSelectableColor(stairs)"
                                    stroke-width="10" stroke-dasharray="2, 5"
                                    [attr.x1]="stairs.p1.x" [attr.y1]="stairs.p1.y"
                                    [attr.x2]="stairs.p2.x" [attr.y2]="stairs.p2.y"
                                    marker-end="url(#circle)" marker-start="url(#circle)"/>
                            <svg:line stroke="grey" [attr.stroke-width]="stairs.width" stroke-dasharray="4, 8"
                                      [attr.x1]="stairs.center.x" [attr.y1]="stairs.center.y"
                                      [attr.x2]="stairs.rearCenter.x" [attr.y2]="stairs.rearCenter.y"
                                      marker-end="url(#solidArrow)"/>
                            <svg:text *ngIf="showLabels" text-anchor="middle"
                                      [attr.x]="stairs.center.x" [attr.y]="stairs.center.y + 20">
                                {{stairs.label}}
                            </svg:text>
                        </svg:g>

                        <svg:g *ngFor="let elevator of floor.elevators">
                            <svg:rect
                                    [attr.stroke]="getSelectableColor(elevator)" stroke-width="10" fill-opacity="0.5"
                                    [attr.x]="elevator.center.x - 30" [attr.y]="elevator.center.y - 30"
                                    width="60" height="60"/>
                            <svg:line
                                    [attr.stroke]="getSelectableColor(elevator)" stroke-width="5"
                                    [attr.x1]="elevator.center.x - 30" [attr.y1]="elevator.center.y - 30"
                                    [attr.x2]="elevator.center.x + 30" [attr.y2]="elevator.center.y + 30"/>
                            <svg:line
                                    [attr.stroke]="getSelectableColor(elevator)" stroke-width="5"
                                    [attr.x1]="elevator.center.x + 30" [attr.y1]="elevator.center.y - 30"
                                    [attr.x2]="elevator.center.x - 30" [attr.y2]="elevator.center.y + 30"/>
                            <svg:circle [attr.cx]="elevator.center.x" [attr.cy]="elevator.center.y" r="4"
                                        style="stroke: none; fill:#000000;"/>
                            <svg:text *ngIf="showLabels" text-anchor="middle"
                                      [attr.x]="elevator.center.x" [attr.y]="elevator.center.y + 20">
                                {{elevator.label}}
                            </svg:text>
                        </svg:g>

                        <svg:g *ngFor="let linepath of movingPaths">
                            <svg:line *ngFor="let path of linepath.path" stroke="red" stroke-width="3"
                                      stroke-linecap="round" stroke-linejoin="bevel"
                                      stroke-dasharray="35,10" fill="none"
                                      [attr.x1]="path.p1.x" [attr.y1]="path.p1.y"
                                      [attr.x2]="path.p2.x" [attr.y2]="path.p2.y"
                                      marker-end="url(#circle)" marker-start="url(#circle)"/>

                              <svg:text *ngIf="linepath.path.length > 0" text-anchor="middle"
                                [attr.x]="linepath.path[linepath.path.length - 1].p1.x" [attr.y]="linepath.path[linepath.path.length - 1].p1.y - 20"
                                fill="red">
                                {{linepath.description}}
                            </svg:text>
                        </svg:g>


                        <!-- Pathfinding Debug -->
                        <svg:circle *ngFor="let node of floor.floorGraph.nodes" [attr.cx]="node.x" [attr.cy]="node.y" r="2" style="stroke: none; fill:green;"/>


                        <svg:circle *ngIf="mouse.xs !== null && mouse.ys !== null"
                                    [attr.cx]="mouse.xs" [attr.cy]="mouse.ys" r="5" style="stroke:red; fill:none"/>
                    </svg:g>

                    <text *ngIf="!floor" x="50%" y="50%" alignment-baseline="middle" text-anchor="middle"
                          font-size="40">
                        Bitte warten...
                    </text>
                </svg>


                <div id="zoom-button-container">
                    <button class="zoom-button" mat-raised-button (click)="zoom(1.1)">
                        <mat-icon aria-label="Zoom +">zoom_in</mat-icon>
                    </button>
                    <button class="zoom-button" mat-raised-button (click)="zoom(0.9)">
                        <mat-icon aria-label="Zoom -">zoom_out</mat-icon>
                    </button>
                    <button class="zoom-button" mat-raised-button (click)="fitToViewport()">
                        <mat-icon aria-label="Zoom -">zoom_out_map</mat-icon>
                    </button>
                </div>
            </div>
            <div id="floor-button-container">
                <mat-button-toggle-group #group="matButtonToggleGroup" value="floors[0]">
                    <mat-button-toggle *ngFor="let f of floors; let i = index" [class.mat-raised-button]="floor == f"
                                       [class.search-result-floor]="f.searchResults.length"
                                       (click)="selectFloor(i)">
                        {{f.label || '?'}}
                    </mat-button-toggle>
                    <div id="floor-spacer"></div>
                    <button mat-raised-button color="accent" *ngIf="!editMode && hasWritePermission"
                            (click)="switchToEditMode()" class="edit-button">
                        <mat-icon aria-label="Edit">edit</mat-icon>
                        <span>Edit mode</span>
                    </button>
                    <button mat-raised-button color="accent" *ngIf="editMode && hasWritePermission"
                            (click)="switchToViewMode()" class="edit-button">
                        <mat-icon aria-label="Edit">pageview</mat-icon>
                        <span>View mode</span>
                    </button>
                </mat-button-toggle-group>


                <div *ngIf="editMode" class="floor-buttons">
                    <button mat-button (click)="createFloor()">
                        <mat-icon>add_circle_outline</mat-icon>
                        New floor
                    </button>
                    <button mat-button (click)="createFloor(floor)">
                        <mat-icon>control_point_duplicate</mat-icon>
                        Clone floor
                    </button>
                    <button mat-button (click)="removeFloor(floor)">
                        <mat-icon>remove_circle_outline</mat-icon>
                        Remove floor
                    </button>
                    <button mat-button (click)="moveFloor(floor, 1)">
                        <mat-icon>vertical_align_top</mat-icon>
                        Move up
                    </button>
                    <button mat-button (click)="moveFloor(floor, -1)">
                        <mat-icon>vertical_align_bottom</mat-icon>
                        Move down
                    </button>
                </div>
            </div>
        </div>
    </div>

</mat-sidenav-container>
